<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>随机题库</title>
    <link rel="stylesheet" href="/bootstrap-3.3.7-dist/css/bootstrap.css"/>
    <link rel="stylesheet" href="/css/base.css"/>
    <link rel="stylesheet" href="/css/navigation.css"/>
    <link rel="stylesheet" href="/css/index.css"/>
    <link rel="stylesheet" href="/iconfont/iconfont.css">

    <script src="/js/jquery-1.11.2.min.js"></script>
    <script src="/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="/js/index.js"></script>
</head>
<body>
    <div class="header">
        <div class="w">
            <!-- 导航栏 -->
            <nav class="nav-top">
                <!-- 左侧导航栏 -->
                <div class="nav-left">
                    <div class="logo">
                        <h1><a href="#">联想</a></h1>
                    </div>
                    <div class="nav-item">
                        <ul>
                            <li><a href="#">首页</a></li>
                            <li><a href="#">文件</a></li>
                            <li><a href="#">关于</a></li>
                        </ul>
                    </div>
                </div>
                <!--  右侧导航栏 -->
                <div class="nav-right">
                    <ul>
                        <li><img src="/images/default.png" alt=""/></li>
                        <li>用户名</li>
                    </ul>
                </div>
            </nav>
        </div>
    </div>

    <div class="main">
        <div class="bg"></div>
        <form action="/question" enctype="multipart/form-data" method="post">
            <div class="question-upload">
                <!--<p>Excel文件</p>-->
                <label for="questionFile"><span class="iconfont icon-upload1" id="questionUpload"></span></label>
                <input type="file" name="questionFile" id="questionFile"/>
            </div>
            <div class="question-info">
                <div class="input-group">
                    <span class="input-group-addon" id="questionBankName">标题</span>
                    <input type="text" autocomplete="off" name="questionBankName" class="form-control"
                           placeholder="联想认证考题" aria-describedby="questionBankName">
                </div>
                <div class="input-group">
                    <span class="input-group-addon" id="questionCount">题目数</span>
                    <input type="text" class="form-control" disabled="disabled"
                           name="totalCount" aria-describedby="questionCount">
                </div>
                <div class="input-group">
                    <span class="input-group-addon" id="questionNumber">出题数</span>
                    <input type="number" autocomplete="off" name="questionRandomNumber" class="form-control"
                           aria-describedby="questionNumber" disabled>
                </div>
                <div class="question-submit">
                    <input class="btn btn-success" type="submit" disabled value="开始出题"></input>
                </div>
            </div>
        </form>
    </div>

    <script type="text/javascript">
        $(function () {
            $("#questionFile").on("change", function () {
                var $files = $(this).prop('files');
//                console.log($files);
                var file = $files[0];
                // 判断是否存在文件
                if(file.length < 0){
                    alert('没有上传的文件');
                    return;
                }
                var allowtypes = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'];
                // 不是指定的文件类型
                if(allowtypes.indexOf(file.type) <= -1){
                    alert('请上传Excel文件');
                    return;
                }

                // 异步上传文件到后台
                var data = new FormData();
                data.append('file', file);
                $.ajax({
                    url: '/questionUpload',
                    type: "POST",
                    data: data,
                    contentType: false, // 必须false才会自动加上正确的Content-Type
                    /**
                     * 必须false才会避开jQuery对 formdata 的默认处理
                     * XMLHttpRequest会对 formdata 进行正确的处理
                     */
                    processData: false,
                    success: function (data) {
                        // 上传失败
                        if(data.status !== 200){
                            // 设置上传图标
                            if($("#questionUpload").hasClass("icon-wenjian")){
                                $("#questionUpload").addClass("icon-upload1");
                            }
                            // 设置文本框禁止修改
                            $(".question-submit").children('input').prop('disabled', true);
                            $("#questionNumber").siblings('input').prop('disabled', true);
                            $("#questionCount").siblings('input').val("");
                            $("#questionBankName").siblings('input').val("");
                            alert(data.message);
                            return;
                        }
                        console.log(data);
                        var totalCount = data.result.totalCount;
                        var title = data.result.questionBankName;

                        $("#questionCount").siblings('input').val(totalCount);
                        $("#questionBankName").siblings('input').val(title);
                        $("#questionNumber").siblings('input').attr('max', totalCount).attr('min', 0);
                        $("#questionNumber").siblings('input').val(totalCount);

                        // 设置按钮为可提交的状态
                        $(".question-submit").children('input').prop('disabled', false);
                        $("#questionNumber").siblings('input').prop('disabled', false);
                        // 设置上传后的图标
                        $("#questionUpload").removeClass("icon-upload1").addClass("icon-wenjian");
                    }
                })
            })
         })
    </script>
</body>
</html>